# Tasks: Simics Watchdog Timer Device Implementation

**Status**: Not Started | In Progress | Completed | Blocked
**Input**: Design documents from `/specs/001-read-the-simics/`
**Prerequisites**: plan.md (required), research.md, data-model.md, contracts/

## Execution Flow (main)
```
1. Load plan.md → Extract: tech stack, libraries, structure
2. Load design docs:
   → data-model.md: Extract entities → model tasks
   → contracts/: Each file → contract test task
   → research.md: Extract decisions → setup tasks
   → Simics: Extract register definitions → DML file tasks (after project structure is generated by MCP server)
3. Simics DML Learning:
   → Add T017-T018 at START of Phase 3.3 (implementation)
   → Read DML_Device_Development_Best_Practices.md + DML_grammar.md
   → Document learnings in research.md
   → Block all DML implementation until complete
4. Generate tasks by category:
   → Setup: project init, dependencies, linting
   → Tests: contract tests, integration tests
   → Core: models, services, CLI commands
   → Integration: DB, middleware, logging
   → Polish: unit tests, performance, docs
5. Apply task rules:
   → Different files = mark [P] for parallel
   → Same file = sequential (no [P])
   → Tests before implementation (TDD)
6. Number tasks sequentially (T001, T002...)
7. Generate dependency graph
7. Create parallel execution examples
8. Validate task completeness:
   → All contracts have tests?
   → All entities have models?
   → All endpoints implemented?
9. Return: SUCCESS (tasks ready for execution)
```

## Format: `[ID] [P?] Description`
- **[P]**: Can run in parallel (different files, no dependencies)
- Include exact file paths in descriptions

## Path Conventions
- **Single project**: `src/`, `tests/` at repository root
- **Web app**: `backend/src/`, `frontend/src/`
- **Mobile**: `api/src/`, `ios/src/` or `android/src/`
- **Simics**: `./simics-project/modules/wdt/`, `./simics-project/modules/wdt/test/` at repository root

## Phase 3.1: Setup
- [x] T001 Verify connection: `get_simics_version()`
- [x] T002 Create project: `create_simics_project(project_path="/home/hfeng1/simics-dml-windsurf/simics-project")`
- [x] T003 Add skeleton: `add_dml_device_skeleton(project_path="/home/hfeng1/simics-dml-windsurf/simics-project", device_name="wdt")`
- [x] T004 [P] Verify build: `build_simics_project(project_path="/home/hfeng1/simics-dml-windsurf/simics-project", module="wdt")`
- [x] T005 **GATE**: Verify research.md exists with required RAG results from /plan phase
- [ ] T006-T012 [P] **RAG queries** (OPTIONAL - only if research.md insufficient):
  * T006: DML syntax basics (docs)
  * T007: Python test patterns (python)
  * T008: Device testing strategy (source)
  * T009: Register implementation (dml)
  * T010: State/checkpointing (dml)
  * T011: Interface implementation (dml)
  * T012: Event handling (dml)

## Phase 3.2: Tests First (TDD) ⚠️ MUST COMPLETE BEFORE 3.3
**CRITICAL: These tests MUST be written and MUST FAIL before ANY implementation**
- [x] T013 [P] Register access test in /home/hfeng1/simics-dml-windsurf/simics-project/modules/wdt/test/s-register-access.py
- [x] T014 [P] Interface behavior test in /home/hfeng1/simics-dml-windsurf/simics-project/modules/wdt/test/s-interface-behavior.py
- [x] T015 [P] Device workflow test in /home/hfeng1/simics-dml-windsurf/simics-project/modules/wdt/test/s-device-workflow.py
- [x] T016 [P] Validate test environment: `run_simics_test(project_path="/home/hfeng1/simics-dml-windsurf/simics-project", suite="modules/wdt/test")`

## Phase 3.3: Core Implementation (ONLY after tests are failing)
- [x] T017 **GATE**: Read .specify/memory/DML_Device_Development_Best_Practices.md → document in research.md
- [x] T018 **GATE**: Read .specify/memory/DML_grammar.md → document in research.md
- [x] T019 **GATE**: Review study notes
- [x] T020 **GATE**: Read device skeleton
- [x] T021 [P] Register definitions in /home/hfeng1/simics-dml-windsurf/simics-project/modules/wdt/wdt.dml
- [x] T022 [P] Interface declarations in /home/hfeng1/simics-dml-windsurf/simics-project/modules/wdt/wdt.dml
- [x] T023 [P] Timer logic implementation in /home/hfeng1/simics-dml-windsurf/simics-project/modules/wdt/wdt.dml
- [x] T024 [P] Lock mechanism implementation in /home/hfeng1/simics-dml-windsurf/simics-project/modules/wdt/wdt.dml
- [x] T025 [P] Integration test mode implementation in /home/hfeng1/simics-dml-windsurf/simics-project/modules/wdt/wdt.dml
- [x] T026 [P] Event handling and signal generation in /home/hfeng1/simics-dml-windsurf/simics-project/modules/wdt/wdt.dml
- [x] T027 [P] State management and checkpointing in /home/hfeng1/simics-dml-windsurf/simics-project/modules/wdt/wdt.dml
- [x] T028 [P] Build: `build_simics_project(project_path="/home/hfeng1/simics-dml-windsurf/simics-project", module="wdt")`
- [x] T029 Error handling and validation
- [x] T030 Documentation and comments

## Phase 3.4: Integration
- [ ] T031 **RAG SEARCH**: Use `perform_rag_query("DML device memory map transact interrupt signal integration patterns", source_type="dml", match_count=5)` for integration patterns
- [ ] T032 Connect device to memory interface using transact() methods
- [ ] T033 Implement interrupt line connections and events
- [ ] T034 Add external port communications and protocols
- [ ] T035 Integrate with Simics checkpointing and state management
- [ ] T036 [P] Validate integration: `build_simics_project(project_path="/home/hfeng1/simics-dml-windsurf/simics-project")`
- [ ] T037 [P] Run comprehensive tests: `run_simics_test(project_path="/home/hfeng1/simics-dml-windsurf/simics-project", suite="modules/wdt/test")`

## Phase 3.5: Polish
- [ ] T038 [P] Unit tests for validation in /home/hfeng1/simics-dml-windsurf/simics-project/modules/wdt/test/s-validation.py
- [ ] T039 Performance tests
- [ ] T040 [P] Update documentation files
- [ ] T041 Remove duplication
- [ ] T042 Run manual-testing.md

## Dependencies

**General**: Tests → Implementation → Polish

**Simics**:
- T001 → T002 → T003 → T004 → T005 → T006-T012 → T013-T016 → T017-T018 → T019-T030 → T031-T037
- **Key**: research.md (T005) → Tests (T013-T016) → DML learning (T017-T018) → Implementation (T019+)

## Parallel Example
```
# Launch T013-T016 together:
Task: "Register access test in /home/hfeng1/simics-dml-windsurf/simics-project/modules/wdt/test/s-register-access.py"
Task: "Interface behavior test in /home/hfeng1/simics-dml-windsurf/simics-project/modules/wdt/test/s-interface-behavior.py"
Task: "Device workflow test in /home/hfeng1/simics-dml-windsurf/simics-project/modules/wdt/test/s-device-workflow.py"
Task: "Validate test environment: run_simics_test(project_path=\"/home/hfeng1/simics-dml-windsurf/simics-project\", suite=\"modules/wdt/test\")"
```

## Notes
- [P] tasks = different files, no dependencies
- Verify tests fail before implementing
- Commit after each task
- Avoid: vague tasks, same file conflicts

## Task Generation Rules
*Applied during main() execution*

1. **From Contracts**: Each file → contract test [P], each endpoint → implementation
2. **From Data Model**: Each entity → model [P], relationships → services
3. **From User Stories**: Each story → integration test [P], quickstart → validation
4. **Ordering**:
   - General: Setup → Tests → Implementation → Integration → Polish
   - **Simics**: Setup → Tests (use research.md) → DML Learning → Implementation → Integration → Polish

## Validation Checklist
*GATE: Checked by main() before returning*

- [x] All contracts have corresponding tests
- [x] All entities have model tasks
- [x] All tests come before implementation
- [x] Parallel tasks truly independent
- [x] Each task specifies exact file path
- [x] No task modifies same file as another [P] task

**Simics-Specific Validation:**
- [x] **All MCP tool calls use ABSOLUTE paths** (SSE transport requirement)
- [x] All MCP tool calls specify correct project_path parameter
- [x] Build validation tasks after implementation changes
- [x] Test execution tasks use appropriate suite parameter
- [x] Device name consistently used across MCP tool calls
- [x] research.md from /plan phase is available and referenced
- [x] Optional RAG searches are only used when research.md is insufficient
- [x] All new RAG search results are documented

## research.md Workflow
**Source**: Created by /plan with comprehensive RAG results
**Usage**: Reference documented patterns (primary source)
**Modifications**: If gaps → create tasks to fill, append new RAG results
**Missing**: ERROR - /plan must complete first

## Critical Gates

### Pre-Test Gate (T005):
- [x] research.md exists with 8 RAG results from /plan
- [x] Reviewed and understood patterns
- [x] Identified applicable patterns

### DML Learning Gate (T017-T018):
- [ ] Read DML_Device_Development_Best_Practices.md completely
- [ ] Read DML_grammar.md completely
- [ ] Document in research.md: "## DML Best Practices Study Notes" + "## DML Grammar Study Notes"
- [ ] Verify comprehensive notes before T019+

**Note**: Tests (T013-T016) use research.md patterns, don't need deep DML study

## Execution Rules
1. **Prerequisites**: Verify research.md exists (T005)
2. **DML Learning**: T017-T018 before ANY DML implementation
3. **Tests First**: T013-T016 use research.md, written before DML learning
4. **Study Notes**: Must reference in all DML tasks
5. **RAG Queries**: OPTIONAL - only if research.md insufficient
6. **MCP Absolute Paths**: ALWAYS use absolute paths for `create_simics_project()`, `build_simics_project()`, `run_simics_test()` (SSE transport requirement)

## Common Failures
- ❌ Skip DML learning (T017-T018)
- ❌ Incomplete study notes
- ❌ Ignore study notes during implementation
- ❌ Test after DML learning (should be before)
- ❌ Duplicate RAG queries (check research.md first)
- ❌ **Use relative paths for MCP tools** (must be absolute for SSE transport)
- ✅ **Correct**: research.md → tests → DML learning → implementation → query only if gaps → absolute paths for all MCP calls

## Error Recovery (Simics)

**Priority**: Study Notes → Source Docs → RAG (last resort)

### Build Errors
1. **Check Grammar Notes**: Search research.md "DML Grammar Study Notes"
   - Syntax errors → declaration/method/expression syntax
   - Semantic errors → scoping/types/visibility
   - Template errors → template system/inheritance
2. **Check Best Practices Notes**: Search "DML Best Practices Study Notes"
   - Pattern errors → coding patterns/interfaces
   - Common pitfalls → anti-patterns section
3. **Check research.md RAG**: Device examples, register patterns from /plan
4. **Read Source**: Open DML_grammar.md or DML_Device_Development_Best_Practices.md, search error keyword
5. **RAG Query**: `perform_rag_query("DML 1.4 [error_keyword] syntax solution", source_type="dml", match_count=10)`
6. **Document**: Add solution to research.md

**Examples**:
```
"syntax error: expected ';'" → Grammar notes → register declaration syntax
"unknown attribute" → Grammar notes → attribute declarations + scoping
"template not found" → Grammar notes → template system (might be interface!)
"checkpoint restore failed" → Best practices → state management patterns
```

### Test Failures
1. **Check Test Patterns**: research.md test sections from /plan
2. **Check Best Practices**: For device behavior issues
3. **Check Grammar**: For interface/method issues
4. **Debugging**: Apply techniques from best practices notes
5. **RAG Query**: `perform_rag_query("Simics Python test [scenario]", source_type="python")`

### Runtime Errors
1. **Check Best Practices** → error scenario
2. **Check Grammar** → verify syntax correctness
3. **Re-read Source** → for complex issues
4. **RAG Query** → similar issues + solutions

**Documentation**: After resolving via steps 4-6, add to research.md:
```markdown
**Error**: [message] → **Solution**: [fix] → **Reference**: [source]
```
