# Tasks: [FEATURE NAME]

**Status**: No## Format: `[ID] [P?] Description`
**[P]** = Can run in parallel (different files, no dependencies)
Include exact file paths in descriptions

**⚠️ CRITICAL - MCP Tool Paths (SSE Transport)**:
- **ALWAYS use ABSOLUTE paths** for MCP tools: `create_simics_project()`, `build_simics_project()`, `run_simics_test()`
- **NEVER use relative paths** like `"./simics-project"` or `"../project"`
- **WHY**: SSE transport MCP servers run in different process/directory context
- **HOW**: Use `os.getcwd()` or workspace root to construct: `"/full/path/to/workspace/simics-project"`
- **Example**: `create_simics_project(project_path="/home/user/workspace/simics-project")`tarted | In Progress | Completed | Blocked
**Input**: Design documents from `/specs/[###-feature-name]/`
**Prerequisites**: plan.md (required), research.md, data-model.md, contracts/

## Execution Flow (main)
```
1. Load plan.md → Extract: tech stack, libraries, structure
2. Load design docs:
   → data-model.md: Extract entities → model tasks
   → contracts/: Each file → contract test task
   → research.md: Extract decisions → setup tasks
   → Simics: Extract register definitions → DML file tasks (after project structure is generated by MCP server)
3. Simics DML Learning:
   → Add T017-T018 at START of Phase 3.3 (implementation)
   → Read DML_Device_Development_Best_Practices.md + DML_grammar.md
   → Document learnings in research.md
   → Block all DML implementation until complete
4. Generate tasks by category:
   → Setup: project init, dependencies, linting
   → Tests: contract tests, integration tests
   → Core: models, services, CLI commands
   → Integration: DB, middleware, logging
   → Polish: unit tests, performance, docs
5. Apply task rules:
   → Different files = mark [P] for parallel
   → Same file = sequential (no [P])
   → Tests before implementation (TDD)
6. Number tasks sequentially (T001, T002...)
7. Generate dependency graph
7. Create parallel execution examples
8. Validate task completeness:
   → All contracts have tests?
   → All entities have models?
   → All endpoints implemented?
9. Return: SUCCESS (tasks ready for execution)
```

## Format: `[ID] [P?] Description`
- **[P]**: Can run in parallel (different files, no dependencies)
- Include exact file paths in descriptions

## Path Conventions
- **Single project**: `src/`, `tests/` at repository root
- **Web app**: `backend/src/`, `frontend/src/`
- **Mobile**: `api/src/`, `ios/src/` or `android/src/`
- **Simics**: `./simics-project/modules/device-name/`, `./simics-project/modules/device-name/test/` at repository root

## Phase 3.1: Setup
- [ ] T001 Create project structure per implementation plan
- [ ] T002 Initialize [language] project with [framework] dependencies
- [ ] T003 [P] Configure linting and formatting tools

**Simics Setup:**
- [ ] T001 Verify connection: `get_simics_version()`
- [ ] T002 Create project: `create_simics_project(project_path="/absolute/path/to/workspace/simics-project")` ⚠️ ABSOLUTE PATH
- [ ] T003 Add skeleton: `add_dml_device_skeleton(project_path="/absolute/path/to/workspace/simics-project", device_name="DEVICE_NAME")` ⚠️ ABSOLUTE PATH
- [ ] T004 Checkout DMLC: `checkout_and_build_dmlc(project_path="/absolute/path/to/workspace/simics-project")` ⚠️ ABSOLUTE PATH
- [ ] T005 [P] Verify build: `build_simics_project(project_path="/absolute/path/to/workspace/simics-project", module="DEVICE_NAME")` ⚠️ ABSOLUTE PATH
- [ ] T006 **GATE**: Verify research.md exists with required RAG results from /plan phase
- [ ] T007-T013 [P] **RAG queries** (OPTIONAL - only if research.md insufficient):
  * T007: DML syntax basics (docs)
  * T008: Python test patterns (python)
  * T009: Device testing strategy (source)
  * T010: Register implementation (dml)
  * T011: State/checkpointing (dml)
  * T012: Interface implementation (dml)
  * T013: Event handling (dml)

## Phase 3.2: Tests First (TDD) ⚠️ MUST COMPLETE BEFORE 3.3
**CRITICAL: These tests MUST be written and MUST FAIL before ANY implementation**
- [ ] T004 [P] Contract test POST /api/users in tests/contract/test_users_post.py
- [ ] T005 [P] Contract test GET /api/users/{id} in tests/contract/test_users_get.py
- [ ] T006 [P] Integration test user registration in tests/integration/test_registration.py
- [ ] T007 [P] Integration test auth flow in tests/integration/test_auth.py

**Simics:**
- [ ] T014 [P] Register access test (use research.md patterns)
- [ ] T015 [P] Interface behavior test
- [ ] T016 [P] Device workflow test
- [ ] T017 [P] Validate test environment: `run_simics_test(project_path="/absolute/path/to/workspace/simics-project", suite="modules/DEVICE_NAME/test")` ⚠️ ABSOLUTE PATH

## Phase 3.3: Core Implementation (ONLY after tests are failing)

**⚠️ CRITICAL BUILD REQUIREMENT (Simics Projects)**:
After implementing EACH task in this phase, MUST run `build_simics_project(project_path="/absolute/path/to/workspace/simics-project", module="DEVICE_NAME")` to verify compilation before marking task done. Do NOT proceed to next task if build fails.

- [ ] T008 [P] User model in src/models/user.py
- [ ] T009 [P] UserService CRUD in src/services/user_service.py
- [ ] T010 [P] CLI --create-user in src/cli/user_commands.py
- [ ] T011 POST /api/users endpoint
- [ ] T012 GET /api/users/{id} endpoint
- [ ] T013 Input validation
- [ ] T014 Error handling and logging

**Simics Project:**
- [ ] T018 **GATE**: Read .specify/memory/DML_Device_Development_Best_Practices.md → document in research.md
- [ ] T019 **GATE**: Read .specify/memory/DML_grammar.md → document in research.md
- [ ] T020 **GATE**: Review study notes
- [ ] T021 **GATE**: Read device skeleton
- [ ] T022 [P] Register definitions (apply grammar + best practices)
- [ ] T023 [P] Interface declarations (apply grammar + best practices)
- [ ] T024 [P] Check DML: `check_with_dmlc(project_path="/absolute/path/to/workspace/simics-project", module="DEVICE_NAME")` ⚠️ ABSOLUTE PATH (validates with AI diagnostics)
- [ ] T025 [P] Build: `build_simics_project(project_path="/absolute/path/to/workspace/simics-project", module="DEVICE_NAME")` ⚠️ ABSOLUTE PATH
- [ ] T026-T029 Register logic, state management, error handling, validation

## Phase 3.4: Integration
- [ ] T015 Connect UserService to DB
- [ ] T016 Auth middleware
- [ ] T017 Request/response logging
- [ ] T018 CORS and security headers

**Simics Integration Example:**
- [ ] T030 **RAG SEARCH**: Use `perform_rag_query("DML device memory map transact interrupt signal integration patterns", source_type="dml", match_count=5)` for integration patterns
- [ ] T031 Connect device to memory interface using transact() methods
- [ ] T032 Implement interrupt line connections and events
- [ ] T033 Add external port communications and protocols
- [ ] T034 Integrate with Simics checkpointing and state management
- [ ] T035 [P] Validate integration: `build_simics_project(project_path="/absolute/path/to/workspace/simics-project")` ⚠️ ABSOLUTE PATH
- [ ] T036 [P] Run comprehensive tests: `run_simics_test(project_path="/absolute/path/to/workspace/simics-project", suite="modules/DEVICE_NAME/test")` ⚠️ ABSOLUTE PATH

## Phase 3.5: Polish
- [ ] T019 [P] Unit tests for validation in tests/unit/test_validation.py
- [ ] T020 Performance tests (<200ms)
- [ ] T021 [P] Update docs/api.md
- [ ] T022 Remove duplication
- [ ] T023 Run manual-testing.md

## Dependencies

**General**: Tests → Implementation → Polish

**Simics**:
- T001 → T002 → T003 → T004 → T005 → T006 → T007-T013 → T014-T017 → T018-T019 → T020-T029 → T030-T036
- **Key**: research.md (T006) → Tests (T014-T017) → DML learning (T018-T019) → Implementation (T020+) → Integration (T030+)


## Parallel Example
```
# Launch T004-T007 together:
Task: "Contract test POST /api/users in tests/contract/test_users_post.py"
Task: "Contract test GET /api/users/{id} in tests/contract/test_users_get.py"
Task: "Integration test registration in tests/integration/test_registration.py"
Task: "Integration test auth in tests/integration/test_auth.py"
```

## Notes
- [P] tasks = different files, no dependencies
- Verify tests fail before implementing
- Commit after each task
- Avoid: vague tasks, same file conflicts

## Task Generation Rules
*Applied during main() execution*

1. **From Contracts**: Each file → contract test [P], each endpoint → implementation
2. **From Data Model**: Each entity → model [P], relationships → services
3. **From User Stories**: Each story → integration test [P], quickstart → validation
4. **Ordering**:
   - General: Setup → Tests → Implementation → Integration → Polish
   - **Simics**: Setup → Tests (use research.md) → DML Learning → Implementation → Integration → Polish

## Validation Checklist
*GATE: Checked by main() before returning*

- [ ] All contracts have corresponding tests
- [ ] All entities have model tasks
- [ ] All tests come before implementation
- [ ] Parallel tasks truly independent
- [ ] Each task specifies exact file path
- [ ] No task modifies same file as another [P] task

**Simics-Specific Validation:**
- [ ] **All MCP tool calls use ABSOLUTE paths** (SSE transport requirement)
- [ ] All MCP tool calls specify correct project_path parameter
- [ ] Build validation tasks after implementation changes
- [ ] Test execution tasks use appropriate suite parameter
- [ ] Device name consistently used across MCP tool calls
- [ ] research.md from /plan phase is available and referenced
- [ ] Optional RAG searches are only used when research.md is insufficient
- [ ] All new RAG search results are documented

## research.md Workflow
**Source**: Created by /plan with comprehensive RAG results
**Usage**: Reference documented patterns (primary source)
**Modifications**: If gaps → create tasks to fill, append new RAG results
**Missing**: ERROR - /plan must complete first

## Critical Gates

### Pre-Test Gate (T005):
- [ ] research.md exists with 8 RAG results from /plan
- [ ] Reviewed and understood patterns
- [ ] Identified applicable patterns

### DML Learning Gate (T017-T018):
- [ ] Read DML_Device_Development_Best_Practices.md completely
- [ ] Read DML_grammar.md completely
- [ ] Document in research.md: "## DML Best Practices Study Notes" + "## DML Grammar Study Notes"
- [ ] Verify comprehensive notes before T019+

**Note**: Tests (T013-T016) use research.md patterns, don't need deep DML study

## Execution Rules
1. **Prerequisites**: Verify research.md exists (T005)
2. **DML Learning**: T017-T018 before ANY DML implementation
3. **Tests First**: T013-T016 use research.md, written before DML learning
4. **Study Notes**: Must reference in all DML tasks
5. **RAG Queries**: OPTIONAL - only if research.md/study notes insufficient
6. **MCP Absolute Paths**: ALWAYS use absolute paths for `create_simics_project()`, `build_simics_project()`, `run_simics_test()` (SSE transport requirement)

## Common Failures
- ❌ Skip DML learning (T017-T018)
- ❌ Incomplete study notes
- ❌ Ignore study notes during implementation
- ❌ Test after DML learning (should be before)
- ❌ Duplicate RAG queries (check research.md first)
- ❌ **Use relative paths for MCP tools** (must be absolute for SSE transport)
- ✅ **Correct**: research.md → tests → DML learning → implementation → query only if gaps → absolute paths for all MCP calls

## Error Recovery (Simics)

**Priority**: Study Notes → Source Docs → RAG (last resort)

### Build Errors
1. **Check Grammar Notes**: Search research.md "DML Grammar Study Notes"
   - Syntax errors → declaration/method/expression syntax
   - Semantic errors → scoping/types/visibility
   - Template errors → template system/inheritance
2. **Check Best Practices Notes**: Search "DML Best Practices Study Notes"
   - Pattern errors → coding patterns/interfaces
   - Common pitfalls → anti-patterns section
3. **Check research.md RAG**: Device examples, register patterns from /plan
4. **Read Source**: Open DML_grammar.md or DML_Device_Development_Best_Practices.md, search error keyword
5. **RAG Query**: `perform_rag_query("DML 1.4 [error_keyword] syntax solution", source_type="dml", match_count=10)`
6. **Document**: Add solution to research.md

**Examples**:
```
"syntax error: expected ';'" → Grammar notes → register declaration syntax
"unknown attribute" → Grammar notes → attribute declarations + scoping
"template not found" → Grammar notes → template system (might be interface!)
"checkpoint restore failed" → Best practices → state management patterns
```

### Test Failures
1. **Check Test Patterns**: research.md test sections from /plan
2. **Check Best Practices**: For device behavior issues
3. **Check Grammar**: For interface/method issues
4. **Debugging**: Apply techniques from best practices notes
5. **RAG Query**: `perform_rag_query("Simics Python test [scenario]", source_type="python")`

### Runtime Errors
1. **Check Best Practices** → error scenario
2. **Check Grammar** → verify syntax correctness
3. **Re-read Source** → for complex issues
4. **RAG Query** → similar issues + solutions

**Documentation**: After resolving via steps 4-6, add to research.md:
```markdown
**Error**: [message] → **Solution**: [fix] → **Reference**: [source]
```
